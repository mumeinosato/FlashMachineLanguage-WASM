# ミニ x86_64 四則演算エミュレーション仕様書

## 1. 基本方針
- 入力は **16 進の機械語列**（バイト列）。
- 実行対象は安全目的のため **ごく限定された x86_64 命令セットのサブセット** のみ。
- 実行環境は
    - **メモリアクセス禁止**（メモリアクセス命令は出現した時点でエラー）。
    - **使用可能な汎用レジスタは 4 種類のみ**：
        - `RAX`, `RBX`, `RCX`, `RDX`
    - 各レジスタは **64bit** として演算するが、最終的な結果評価は int32 範囲で行う。

## 2. レジスタ初期状態
- 全レジスタ（RAX/RBX/RCX/RDX）は **0 で初期化**。

## 3. 許可される命令
すべて x86_64 の実際の機械語フォーマットに従う。

### 3.1 MOV
- `mov reg, imm32`
    - imm32 は **sign-extend されて 64bit** に広げられる。
- `mov reg, reg`

### 3.2 加減算（int64 演算）
- `add reg, reg`
- `add reg, imm32`
- `sub reg, reg`
- `sub reg, imm32`

### 3.3 使用可能なレジスタ
- `RAX`, `RBX`, `RCX`, `RDX`

### 3.4 使用禁止（検出したら即エラー）
- メモリアクセス (`mov [mem],reg`/`mov reg,[mem]` など)
- push/pop/call/ret/jmp/jcc などの制御命令
- mul, imul, div, idiv（現在は非許可）
- システムコール系命令
- その他すべての未許可命令

## 4. 即値 (imm)
- imm は **32bit 即値（imm32）** のみ許可。
- 機械語中の形式に従い sign-extend 可。

## 5. 実行モデル
- 命令長可変（x86_64 本来の仕様通りデコード）。
- **終了命令は存在しない**：
    - 入力バイト列をすべてデコードし、最後まで実行したら終了。

## 6. エラーモデル
以下の状況はすべて **エラーとして即停止し、該当命令と理由を出力**。

- 許可されていない命令が現れた場合
- メモリアクセス命令の出現
- オーバーフロー（int64 演算中に発生した場合）
- imm のサイズが仕様外
- レジスタ指定が仕様外のもの (`rsi` 等)

## 7. 実行後の結果評価
- 最終的な **RAX の値を演算結果** とみなす。
- RAX の値が **int32 範囲を超えた場合は -1 として扱う**。

## 8. 目的
- アセンブリを短く書けるように、imm32 の使用を許可。
- 安全性確保のため限定命令セットを用いる。
- x86_64 のフォーマットは忠実に守った上で、ミニ CPU 的な挙動を提供する。

